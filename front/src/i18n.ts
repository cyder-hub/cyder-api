import { createSignal, Accessor, Setter, createResource, createMemo } from 'solid-js';
import { flatten, translator, resolveTemplate } from '@solid-primitives/i18n';

// Define your dictionaries here
const enDict = {
    providerPage: {
        editModel: "Edit model: {{model_name}}",
    },
    providerPageTitle: "Providers Management",
    addProvider: "Add New Provider",
    providersLoading: "Loading providers...",
    providersError: "Error loading providers: {{error}}",
    noProviders: "No providers found. Click 'Add New Provider' to get started.",
    tableHeaderKey: "Key",
    name: "Name",
    tableHeaderType: "Type",
    tableHeaderUseProxy: "Use Proxy",
    tableHeaderLimitModel: "Limit Model",
    providerModels: "Models",
    providerApiKeys: "API Keys",
    actions: "Actions",
    dashboard: {
        systemOverview: {
            title: "System Overview",
            providers: "Total Providers",
            models: "Total Models",
            providerKeys: "Total Provider API Keys",
        },
        todayLogStats: {
            title: "Today's Request Log Stats",
            requests: "Requests Today",
            promptTokens: "Prompt Tokens Today",
            completionTokens: "Completion Tokens Today",
            reasoningTokens: "Reasoning Tokens Today",
            totalTokens: "Total Tokens Today",
            totalCost: "Total Cost Today",
        },
        usageStats: {
            title: "Usage Statistics",
            noData: "No data available for this period",
            total: "Total",
            summary: {
                title: "Summary by Model",
                model: "Model",
            },
            intervals: {
                hour: "Hourly",
                day: "Daily",
                month: "Monthly",
            },
            timeRanges: {
                last_1_hour: "Last 1 hour",
                last_3_hours: "Last 3 hours",
                last_6_hours: "Last 6 hours",
                last_24_hours: "Last 24 hours",
                today: "Today",
                yesterday: "Yesterday",
                this_week: "This week",
                last_7_days: "Last 7 days",
                previous_week: "Previous week",
                this_month: "This month",
                last_30_days: "Last 30 days",
                previous_month: "Previous month",
                last_6_months: "Last 6 months",
                this_year: "This year",
                last_1_year: "Last year",
            },
            metrics: {
                prompt_tokens: "Prompt Tokens",
                completion_tokens: "Completion Tokens",
                reasoning_tokens: "Reasoning Tokens",
                total_tokens: "Total Tokens",
                request_count: "Request Count",
                total_cost: "Total Cost",
            },
            chartTypes: {
                line: "Line",
                bar: "Bar",
            },
        },
        errorLoading: "Error loading stats: {{error}}",
    },
    edit: "Edit",
    delete: "Delete",
    confirmDeleteProvider: "Are you sure you want to delete the provider '{{name}}'?",
    deleteFailed: "Failed to delete provider: {{error}}",
    unknownError: "An unknown error occurred.",
    recordYes: "Yes",
    recordNo: "No",
    currencies: {
        USD: "USD",
        CNY: "CNY",
    },
    // Add other general translations if needed
    loading: "Loading...",
    sidebar: {
        dashboard: "Dashboard",
        record: "Record",
        provider: "Provider",
        apiKey: "API Key",
        modelTransform: "Model Transform",
        limitStrategy: "Limit Strategy",
        customFields: "Custom Fields",
        price: "Price",
    },
    appHeader: "AI Gateway Manager",
    appFooter: "© 2025 AI Gateway Manager. All rights reserved.",
    toggleSidebar: "Toggle Sidebar",
    language: {
        english: "English",
        chinese: "Chinese",
    },
    recordPage: {
        title: "Request Records",
        filter: {
            apiKeyPlaceholder: "Select API Key",
            allApiKeys: "All API Keys",
            apiKeyLabel: "API Key",
            providerPlaceholder: "Select Provider",
            allProviders: "All Providers",
            providerLabel: "Provider",
            modelNameLabel: "Model Name",
            modelNamePlaceholder: "Model Name",
            applyButton: "Apply Filter",
            resetButton: "Reset",
        },
        loading: "Loading records...",
        errorPrefix: "Error loading records:",
        unknownError: "Unknown error",
        table: {
            modelName: "Model Name",
            provider: "Provider",
            apiKey: "API Key",
            status: "Status",
            promptTokens: "Prompt Tokens",
            completionTokens: "Completion Tokens",
            reasoningTokens: "Reasoning Tokens",
            totalTokens: "Total Tokens",
            stream: "Stream",
            firstResp: "First Resp (s)",
            totalResp: "Total Resp (s)",
            tps: "TPS",
            cost: "Cost",
            requestTime: "Request Time",
            noRecordsMatch: "No records found matching your criteria.",
            noRecordsAvailable: "No records available.",
            viewDetails: "Details",
        },
        pagination: {
            previousPage: "Previous Page",
            nextPage: "Next Page",
            page: "Page",
            of: "of",
            items: "items",
            itemsPerPage: "Items per page:",
            selectItemsPerPage: "Select number of items per page",
        },
    },
    common: {
        yes: "Yes",
        no: "No",
        edit: "Edit",
        delete: "Delete",
        save: "Save Changes",
        cancel: "Cancel",
        notAvailable: "N/A",
        refresh: "Refresh",
    },
    apiKeyPage: {
        title: "API Key Management",
        addApiKey: "Add API Key",
        loading: "Loading API keys...",
        errorPrefix: "Error loading API keys:",
        noData: "No API Key data available.",
        table: {
            name: "Name",
            apiKeyPartial: "API Key (Partial)",
            description: "Description",
            enabled: "Enabled",
            createdAt: "Created At",
            updatedAt: "Updated At",
            actions: "Actions",
        },
        copy: "Copy full key",
        copied: "Copied!",
        confirmDelete: "Are you sure you want to delete API Key '{{name}}'?",
        copyFailed: "Failed to copy API key.",
        toggleStatusFailed: "Error toggling API key status: {{error}}",
    },
    apiKeyEditModal: {
        titleEdit: "Edit API Key",
        titleAdd: "Add API Key",
        labelName: "Name",
        labelApiKey: "API Key",
        apiKeyHelpText: "(Leave blank to keep unchanged)",
        apiKeyPlaceholderEdit: "Enter new key to change",
        apiKeyPlaceholderNew: "Enter API Key",
        buttonShow: "Show",
        buttonHide: "Hide",
        labelDescription: "Description",
        labelEnabled: "Enabled",
        alert: {
            formDataError: "Error: Form data is not available. Please try again.",
            nameRequired: "Name cannot be empty.",
            apiKeyRequired: "API Key cannot be empty.",
            saveFailed: "Save failed: {{error}}",
        }
    },
    modelAliasPage: {
        title: "Model Transform",
        addModelAlias: "Add Model Transform",
        loading: "Loading model transforms...",
        errorPrefix: "Error loading model transforms.",
        noData: "No model transforms found.",
        table: {
            aliasName: "Model Name",
            targetModelName: "Mapped Model Name",
            enabled: "Enabled",
        },
        modal: {
            titleEdit: "Edit Model Transform",
            titleAdd: "Add Model Transform",
            labelAliasName: "Model Alias",
            placeholderAliasName: "e.g. gpt-4-alias",
            labelTargetProvider: "Target Model's Provider",
            placeholderProvider: "Select Provider",
            labelTargetModel: "Target Model Name",
            placeholderModel: "Select Model",
            labelEnabled: "Enabled",
        },
        alert: {
            loadDetailFailed: "Failed to load model transform details or target_model_id missing.",
            nameAndTargetRequired: "Model Name and Mapped Model (selected from provider) cannot be empty.",
            saveFailed: "Error saving model transform: {{error}}",
            toggleFailed: "Error toggling model transform: {{error}}",
            deleteFailed: "Error deleting model transform: {{error}}",
        },
        confirmDelete: "Are you sure you want to delete model transform '{{name}}'?",
    },
    providerEditPage: {
        titleEdit: "Edit Provider",
        titleAdd: "Add New Provider",
        loadingData: "Loading provider data...",
        alert: {
            fetchDetailFailed: "Failed to fetch provider detail for ID {{providerId}}",
            loadDataFailed: "Failed to load provider data for ID: {{providerId}}.",
            nameRequired: "Name cannot be empty.",
            providerKeyRequired: "Provider Key cannot be empty.",
            endpointRequired: "Endpoint cannot be empty.",
            baseInfoUpdateSuccess: "Provider base information updated successfully.",
            createSuccess: "Provider created successfully. You can now add models and API Keys.",
            baseInfoSaveFailed: "Failed to save provider base information: {{error}}",
            providerNotSavedForApiKey: "Provider must be saved before API Keys can be added.",
            apiKeyRequiredWithIndex: "API Key #{{index}} cannot be empty.",
            vertexApiKeyMissingFields: "Vertex API Key #{{index}} (JSON) is missing or has empty fields: {{fields}}.",
            vertexApiKeyInvalidJson: "Vertex API Key #{{index}} must be a valid JSON format.",
            saveApiKeyFailed: "Failed to save API Key: {{error}}",
            providerNotSavedForModel: "Provider must be saved before models can be added or edited.",
            modelIdRequiredWithIndex: "Model ID for model #{{index}} cannot be empty.",
            saveModelFailed: "Failed to save model: {{error}}",
            providerNotSavedForModelDelete: "Provider not saved, cannot delete model from backend.",
            deleteModelFailed: "Failed to delete model: {{error}}",
            deleteApiKeyFailed: "Failed to delete API Key: {{error}}",
        },
        labelName: "Name",
        labelProviderKey: "Provider Key",
        labelProviderType: "Provider Type",
        labelEndpoint: "Endpoint",
        labelUseProxy: "Use Proxy",
        labelLimitModel: "Limit Model",
        placeholderProviderType: "Select Provider Type",
        buttonUpdateBaseInfo: "Update Provider Base Info",
        buttonCreateBaseInfo: "Create Provider & Save Base Info",
        sectionModels: "Models",
        tableHeaderModelId: "Model ID",
        tableHeaderMappedModelId: "Mapped Model ID",
        placeholderModelId: "e.g., gpt-3.5-turbo",
        placeholderMappedModelId: "e.g., azure-gpt-35 (optional)",
        buttonSaveModel: "Save Model",
        buttonAddModel: "Add Model",
        sectionApiKeys: "API Keys",
        tableHeaderApiKey: "API Key",
        tableHeaderDescription: "Description",
        tableHeaderActions: "Actions",
        placeholderApiKey: "Enter API Key",
        placeholderDescription: "Optional description",
        buttonSaveThisKey: "Save This Key",
        buttonAddApiKey: "Add API Key",
        sectionCustomFields: "Custom Fields",
        tableHeaderFieldName: "Field Name",
        tableHeaderFieldValue: "Field Value",
        tableHeaderFieldType: "Field Type",
        buttonAddCustomField: "Add Custom Field",
        buttonBackToList: "Back to List",
    },
    modelEditPage: {
        title: "Edit Model",
        loading: "Loading model data...",
        labelModelName: "Model Name",
        labelRealModelName: "Real Model Name",
        labelEnabled: "Enabled",
        sectionCustomFields: "Custom Fields",
        tableHeaderFieldName: "Field Name",
        tableHeaderFieldValue: "Field Value",
        tableHeaderDescription: "Description",
        tableHeaderFieldType: "Field Type",
        placeholderSelectCustomField: "Select a custom field to link",
        labelSelectCustomField: "Select Custom Field",
        buttonAddCustomField: "Link Custom Field",
        alert: {
            missingId: "Model ID is missing. Cannot edit.",
            loadDataFailed: "Failed to load model data for ID: {{modelId}}.",
            nameRequired: "Model Name cannot be empty.",
            updateSuccess: "Model updated successfully.",
            saveFailed: "Failed to save model: {{error}}",
            selectFieldToLink: "Please select a custom field to link.",
            modelNotLoaded: "Model data not loaded, cannot link field.",
            linkSuccess: "Custom field linked successfully.",
            linkFailed: "Failed to link custom field: {{error}}",
            modelIdNotFound: "Model ID not found, cannot unlink field.",
            unlinkSuccess: "Custom field unlinked successfully.",
            unlinkFailed: "Failed to unlink custom field: {{error}}",
            fetchCustomFieldsFailed: "Failed to fetch custom fields.",
        },
        priceSection: {
            title: "Price Management",
            labelBillingPlan: "Billing Plan",
            placeholderBillingPlan: "Select a billing plan",
            noPlan: "None (No billing)",
        }
    },
    customFieldsPage: {
        title: "Custom Fields",
        addCustomField: "Add Custom Field",
        errorPrefix: "Error loading custom fields:",
        noData: "No custom fields found.",
        table: {
            name: "Name",
            fieldName: "Field Name",
            fieldType: "Field Type",
            placement: "Placement",
            enabled: "Enabled",
        },
        alert: {
            loadDetailFailed: "Failed to load custom field detail.",
            nameAndTypeRequired: "Field Name and Field Type cannot be empty.",
            saveFailed: "Failed to save custom field: {{error}}",
            toggleFailed: "Failed to toggle custom field status: {{error}}",
            deleteFailed: "Failed to delete custom field: {{error}}",
        },
        confirmDelete: "Are you sure you want to delete custom field '{{name}}'?",
        modal: {
            titleEdit: "Edit Custom Field",
            titleAdd: "Add Custom Field",
            labelName: "Name",
            placeholderName: "Optional display name",
            labelDescription: "Description",
            placeholderDescription: "Optional description",
            labelFieldName: "Field Name",
            placeholderFieldName: "e.g., x-request-id",
            labelPlacement: "Placement",
            placeholderPlacement: "Select a placement",
            labelFieldType: "Field Type",
            placeholderFieldType: "Select a field type",
            labelValue: "Value",
            placeholderStringValue: "Enter string value",
            placeholderJsonStringValue: "Enter a valid JSON string",
            placeholderIntegerValue: "Enter integer value",
            placeholderNumberValue: "Enter number value",
            labelEnabled: "Enabled",
        }
    },
    pricePage: {
        title: "Price Management",
        confirmDeletePlan: "Are you sure you want to delete billing plan '{{name}}'?",
        confirmDeleteRule: "Are you sure you want to delete this price rule?",
        alert: {
            planNameRequired: "Plan name is required.",
            planSaveSuccess: "Billing plan saved successfully.",
            planSaveFailed: "Failed to save billing plan: {{error}}",
            planDeleteSuccess: "Billing plan deleted successfully.",
            planDeleteFailed: "Failed to delete billing plan: {{error}}",
            selectPlanFirst: "Please select a billing plan first.",
            ruleSaveSuccess: "Price rule saved successfully.",
            ruleSaveFailed: "Failed to save price rule: {{error}}",
            ruleDeleteSuccess: "Price rule deleted successfully.",
            ruleDeleteFailed: "Failed to delete price rule: {{error}}",
        },
        plans: {
            title: "Billing Plans",
            add: "Add Billing Plan",
            loading: "Loading billing plans...",
            table: {
                name: "Name",
                description: "Description",
                currency: "Currency",
                actions: "Actions",
            },
            modal: {
                titleEdit: "Edit Billing Plan",
                titleAdd: "New Billing Plan",
                name: "Name",
                description: "Description",
                currency: "Currency",
            },
        },
        rules: {
            title: "Price Rules",
            add: "Add Price Rule",
            loading: "Loading price rules...",
            table: {
                description: "Description",
                enabled: "Enabled",
                usageType: "Usage Type",
                mediaType: "Media Type",
                price: "Price",
                effectiveFrom: "Effective From",
                actions: "Actions",
            },
            modal: {
                titleEdit: "Edit Price Rule",
                titleAdd: "New Price Rule",
                description: "Description",
                enabled: "Enabled",
                usageType: "Usage Type",
                mediaType: "Media Type",
                mediaTypeDefault: "Default (Any)",
                price: "Price ($ / 1M tokens)",
                currency: "Currency",
                effectiveFrom: "Effective From",
                effectiveUntil: "Effective Until",
            },
        },
    },
};

// You can add more dictionaries for other languages
const zhDict = {
    providerPage: {
        editModel: "编辑模型: {{model_name}}",
    },
    providerPageTitle: "渠道管理",
    addProvider: "添加新渠道",
    providersLoading: "正在加载渠道...",
    providersError: "加载渠道错误: {{error}}",
    noProviders: "未找到渠道。点击“添加新渠道”开始。",
    tableHeaderKey: "密钥",
    name: "名称",
    tableHeaderType: "类型",
    tableHeaderUseProxy: "使用代理",
    tableHeaderLimitModel: "限制模型",
    providerModels: "模型",
    providerApiKeys: "API密钥",
    actions: "操作",
    dashboard: {
        systemOverview: {
            title: "系统总览",
            providers: "渠道总数",
            models: "模型总数",
            providerKeys: "渠道API密钥总数",
        },
        todayLogStats: {
            title: "今日请求日志统计",
            requests: "今日请求数",
            promptTokens: "今日Prompt Tokens",
            completionTokens: "今日Completion Tokens",
            reasoningTokens: "今日Reasoning Tokens",
            totalTokens: "今日Total Tokens",
            totalCost: "今日总费用",
        },
        usageStats: {
            title: "使用情况统计",
            noData: "此期间无可用数据",
            total: "总计",
            summary: {
                title: "按模型汇总",
                model: "模型",
            },
            intervals: {
                hour: "每小时",
                day: "每天",
                month: "每月",
            },
            timeRanges: {
                last_1_hour: "过去1小时",
                last_3_hours: "过去3小时",
                last_6_hours: "过去6小时",
                last_24_hours: "过去24小时",
                today: "今天",
                yesterday: "昨天",
                this_week: "本周",
                last_7_days: "过去7天",
                previous_week: "上周",
                this_month: "本月",
                last_30_days: "过去30天",
                previous_month: "上个月",
                last_6_months: "过去6个月",
                this_year: "今年",
                last_1_year: "过去一年",
            },
            metrics: {
                prompt_tokens: "输入 Tokens",
                completion_tokens: "输出 Tokens",
                reasoning_tokens: "推理 Tokens",
                total_tokens: "总 Tokens",
                request_count: "请求数",
                total_cost: "总费用",
            },
            chartTypes: {
                line: "折线图",
                bar: "柱状图",
            },
        },
        errorLoading: "加载统计数据错误: {{error}}",
    },
    edit: "编辑",
    delete: "删除",
    confirmDeleteProvider: "您确定要删除渠道“{{name}}”吗？",
    deleteFailed: "删除渠道失败: {{error}}",
    unknownError: "发生未知错误。",
    recordYes: "是",
    recordNo: "否",
    currencies: {
        USD: "美元",
        CNY: "人民币",
    },
    loading: "加载中...",
    sidebar: {
        dashboard: "仪表盘",
        record: "记录",
        provider: "渠道",
        apiKey: "API密钥",
        modelTransform: "模型转换",
        limitStrategy: "限制策略",
        customFields: "自定义字段",
        price: "价格",
    },
    appHeader: "AI网关管理器",
    appFooter: "© 2025 AI网关管理器. 版权所有.",
    toggleSidebar: "切换侧边栏",
    language: {
        english: "英文",
        chinese: "中文",
    },
    recordPage: {
        title: "请求记录",
        filter: {
            apiKeyPlaceholder: "选择API Key",
            allApiKeys: "所有API Keys",
            apiKeyLabel: "API Key",
            providerPlaceholder: "选择渠道",
            allProviders: "所有渠道",
            providerLabel: "渠道",
            modelNameLabel: "模型名称",
            modelNamePlaceholder: "模型名称",
            applyButton: "应用筛选",
            resetButton: "重置",
        },
        loading: "正在加载记录...",
        errorPrefix: "加载记录错误：",
        unknownError: "未知错误",
        table: {
            modelName: "模型名称",
            provider: "渠道",
            apiKey: "API Key",
            status: "状态",
            promptTokens: "prompt token数",
            completionTokens: "completion token数",
            reasoningTokens: "reasoning token数",
            totalTokens: "总计",
            stream: "Stream",
            firstResp: "首次响应 (秒)",
            totalResp: "总响应 (秒)",
            tps: "TPS",
            cost: "费用",
            requestTime: "请求时间",
            noRecordsMatch: "未找到符合条件的记录。",
            noRecordsAvailable: "无可用记录。",
            viewDetails: "详情",
        },
        pagination: {
            previousPage: "上一页",
            nextPage: "下一页",
            page: "第",
            of: "页, 共",
            items: "条",
            itemsPerPage: "每页显示条数：",
            selectItemsPerPage: "选择每页显示条数",
        },
    },
    common: {
        yes: "是",
        no: "否",
        edit: "编辑",
        delete: "删除",
        save: "保存更改",
        cancel: "取消",
        notAvailable: "无",
        refresh: "刷新",
    },
    apiKeyPage: {
        title: "API Key 管理",
        addApiKey: "添加 API Key",
        loading: "正在加载 API Key...",
        errorPrefix: "加载 API Key 错误:",
        noData: "暂无 API Key 数据.",
        table: {
            name: "名称",
            apiKeyPartial: "API Key (部分)",
            description: "描述",
            enabled: "启用",
            createdAt: "创建时间",
            updatedAt: "更新时间",
            actions: "操作",
        },
        copy: "复制完整密钥",
        copied: "已复制!",
        confirmDelete: "您确定要删除 API Key “{{name}}” 吗？",
        copyFailed: "复制 API Key 失败。",
        toggleStatusFailed: "切换 API Key 状态失败: {{error}}",
    },
    apiKeyEditModal: {
        titleEdit: "编辑 API Key",
        titleAdd: "新增 API Key",
        labelName: "名称",
        labelApiKey: "API Key",
        apiKeyHelpText: "(留空则不修改)",
        apiKeyPlaceholderEdit: "输入新密钥以更改",
        apiKeyPlaceholderNew: "输入 API Key",
        buttonShow: "显示",
        buttonHide: "隐藏",
        labelDescription: "描述",
        labelEnabled: "启用",
        alert: {
            formDataError: "错误：表单数据不可用。请重试。",
            nameRequired: "名称 不能为空。",
            apiKeyRequired: "API Key 不能为空。",
            saveFailed: "保存失败: {{error}}",
        }
    },
    modelAliasPage: {
        title: "模型转换",
        addModelAlias: "添加模型转换",
        loading: "正在加载模型转换...",
        errorPrefix: "加载模型转换错误。",
        noData: "未找到模型转换。",
        table: {
            aliasName: "模型名称",
            targetModelName: "映射模型名称",
            enabled: "是否启用",
        },
        modal: {
            titleEdit: "编辑模型转换",
            titleAdd: "添加模型转换",
            labelAliasName: "模型别名",
            placeholderAliasName: "例如 gpt-4-alias",
            labelTargetProvider: "目标模型所属渠道",
            placeholderProvider: "选择渠道",
            labelTargetModel: "目标模型名称",
            placeholderModel: "选择模型",
            labelEnabled: "是否启用",
        },
        alert: {
            loadDetailFailed: "加载模型转换详情失败或目标模型ID丢失。",
            nameAndTargetRequired: "模型名称和映射模型 (从渠道选择) 不能为空。",
            saveFailed: "保存模型转换错误: {{error}}",
            toggleFailed: "切换模型转换状态错误: {{error}}",
            deleteFailed: "删除模型转换错误: {{error}}",
        },
        confirmDelete: "您确定要删除模型转换 “{{name}}” 吗？",
    },
    providerEditPage: {
        titleEdit: "编辑渠道",
        titleAdd: "新增渠道",
        loadingData: "正在加载渠道数据...",
        alert: {
            fetchDetailFailed: "获取渠道详情失败，ID {{providerId}}",
            loadDataFailed: "加载渠道数据失败，ID: {{providerId}}。",
            nameRequired: "名称 不能为空。",
            providerKeyRequired: "渠道标识 不能为空。",
            endpointRequired: "地址 不能为空。",
            baseInfoUpdateSuccess: "渠道基本信息更新成功。",
            createSuccess: "渠道创建成功。现在您可以添加模型和 API Keys。",
            baseInfoSaveFailed: "保存渠道基本信息失败: {{error}}",
            providerNotSavedForApiKey: "必须先保存渠道，然后才能添加 API Key。",
            apiKeyRequiredWithIndex: "API Key #{{index}} 不能为空。",
            vertexApiKeyMissingFields: "Vertex API Key #{{index}} (JSON) 缺少或为空的字段: {{fields}}。",
            vertexApiKeyInvalidJson: "Vertex API Key #{{index}} 必须是有效的 JSON 格式。",
            saveApiKeyFailed: "保存 API Key 失败: {{error}}",
            providerNotSavedForModel: "必须先保存渠道，然后才能添加或编辑模型。",
            modelIdRequiredWithIndex: "模型 #{{index}} 的模型ID不能为空。",
            saveModelFailed: "保存模型失败: {{error}}",
            providerNotSavedForModelDelete: "渠道未保存，无法从后端删除模型。",
            deleteModelFailed: "删除模型失败: {{error}}",
            deleteApiKeyFailed: "删除 API Key 失败: {{error}}",
        },
        labelName: "名称",
        labelProviderKey: "渠道标识",
        labelProviderType: "渠道类型",
        labelEndpoint: "地址",
        labelUseProxy: "使用代理",
        labelLimitModel: "限制模型",
        placeholderProviderType: "选择渠道类型",
        buttonUpdateBaseInfo: "更新渠道基本信息",
        buttonCreateBaseInfo: "创建渠道并保存基本信息",
        sectionModels: "模型",
        tableHeaderModelId: "模型ID",
        tableHeaderMappedModelId: "映射模型ID",
        placeholderModelId: "例如 gpt-3.5-turbo",
        placeholderMappedModelId: "例如 azure-gpt-35 (可选)",
        buttonSaveModel: "保存模型",
        buttonAddModel: "添加模型",
        sectionApiKeys: "API Keys",
        tableHeaderApiKey: "API Key",
        tableHeaderDescription: "描述",
        tableHeaderActions: "操作",
        placeholderApiKey: "输入 API Key",
        placeholderDescription: "可选描述",
        buttonSaveThisKey: "保存此Key",
        buttonAddApiKey: "添加API Key",
        sectionCustomFields: "自定义字段",
        tableHeaderFieldName: "字段名",
        tableHeaderFieldValue: "字段值",
        tableHeaderFieldType: "字段类型",
        buttonAddCustomField: "添加自定义字段",
        buttonBackToList: "返回列表",
    },
    modelEditPage: {
        title: "编辑模型",
        loading: "正在加载模型数据...",
        labelModelName: "模型名称",
        labelRealModelName: "真实模型名称",
        labelEnabled: "已启用",
        sectionCustomFields: "自定义字段",
        tableHeaderFieldName: "字段名",
        tableHeaderFieldValue: "字段值",
        tableHeaderDescription: "描述",
        tableHeaderFieldType: "字段类型",
        placeholderSelectCustomField: "选择要关联的自定义字段",
        labelSelectCustomField: "选择自定义字段",
        buttonAddCustomField: "关联自定义字段",
        alert: {
            missingId: "缺少模型ID，无法编辑。",
            loadDataFailed: "加载模型数据失败，ID: {{modelId}}。",
            nameRequired: "模型名称不能为空。",
            updateSuccess: "模型更新成功。",
            saveFailed: "保存模型失败: {{error}}",
            selectFieldToLink: "请选择要关联的自定义字段。",
            modelNotLoaded: "模型数据未加载，无法关联字段。",
            linkSuccess: "自定义字段关联成功。",
            linkFailed: "关联自定义字段失败: {{error}}",
            modelIdNotFound: "未找到模型ID，无法取消关联字段。",
            unlinkSuccess: "自定义字段取消关联成功。",
            unlinkFailed: "取消关联自定义字段失败: {{error}}",
            fetchCustomFieldsFailed: "获取自定义字段失败。",
        },
        priceSection: {
            title: "价格管理",
            labelBillingPlan: "计费计划",
            placeholderBillingPlan: "选择一个计费计划",
            noPlan: "无 (不计费)",
        }
    },
    customFieldsPage: {
        title: "自定义字段",
        addCustomField: "添加自定义字段",
        errorPrefix: "加载自定义字段错误:",
        noData: "未找到自定义字段。",
        table: {
            name: "名称",
            fieldName: "字段名",
            fieldType: "字段类型",
            placement: "位置",
            enabled: "启用",
        },
        alert: {
            loadDetailFailed: "加载自定义字段详情失败。",
            nameAndTypeRequired: "字段名和字段类型不能为空。",
            saveFailed: "保存自定义字段失败: {{error}}",
            toggleFailed: "切换自定义字段状态失败: {{error}}",
            deleteFailed: "删除自定义字段失败: {{error}}",
        },
        confirmDelete: "您确定要删除自定义字段“{{name}}”吗？",
        modal: {
            titleEdit: "编辑自定义字段",
            titleAdd: "添加自定义字段",
            labelName: "名称",
            placeholderName: "可选的显示名称",
            labelDescription: "描述",
            placeholderDescription: "可选的描述",
            labelFieldName: "字段名",
            placeholderFieldName: "例如, x-request-id",
            labelPlacement: "位置",
            placeholderPlacement: "选择一个位置",
            labelFieldType: "字段类型",
            placeholderFieldType: "选择一个字段类型",
            labelValue: "值",
            placeholderStringValue: "输入字符串值",
            placeholderJsonStringValue: "输入有效的JSON字符串",
            placeholderIntegerValue: "输入整数值",
            placeholderNumberValue: "输入数值",
            labelEnabled: "启用",
        }
    },
    pricePage: {
        title: "价格管理",
        confirmDeletePlan: "您确定要删除计费计划“{{name}}”吗？",
        confirmDeleteRule: "您确定要删除此价格规则吗？",
        alert: {
            planNameRequired: "计划名称是必填项。",
            planSaveSuccess: "计费计划保存成功。",
            planSaveFailed: "保存计费计划失败: {{error}}",
            planDeleteSuccess: "计费计划删除成功。",
            planDeleteFailed: "删除计费计划失败: {{error}}",
            selectPlanFirst: "请先选择一个计费计划。",
            ruleSaveSuccess: "价格规则保存成功。",
            ruleSaveFailed: "保存价格规则失败: {{error}}",
            ruleDeleteSuccess: "价格规则删除成功。",
            ruleDeleteFailed: "删除价格规则失败: {{error}}",
        },
        plans: {
            title: "计费计划",
            add: "添加计费计划",
            loading: "正在加载计费计划...",
            table: {
                name: "名称",
                description: "描述",
                currency: "货币",
                actions: "操作",
            },
            modal: {
                titleEdit: "编辑计费计划",
                titleAdd: "新建计费计划",
                name: "名称",
                description: "描述",
                currency: "货币",
            },
        },
        rules: {
            title: "价格规则",
            add: "添加价格规则",
            loading: "正在加载价格规则...",
            table: {
                description: "描述",
                enabled: "已启用",
                usageType: "使用类型",
                mediaType: "媒体类型",
                price: "价格",
                effectiveFrom: "生效时间",
                actions: "操作",
            },
            modal: {
                titleEdit: "编辑价格规则",
                titleAdd: "新建价格规则",
                description: "描述",
                enabled: "已启用",
                usageType: "使用类型",
                mediaType: "媒体类型",
                mediaTypeDefault: "默认 (任何)",
                price: "价格 ($ / 百万 tokens)",
                currency: "货币",
                effectiveFrom: "生效时间",
                effectiveUntil: "失效时间",
            },
        },
    },
};

const dictionaries = {
    en: enDict,
    zh: zhDict,
};

// Default language
const defaultLang = "en";

// Type for the translation function arguments, matching resolveTemplate
type TranslationArgs = Record<string, string | number>;

// Type for the translation function itself
type TranslatorFn = (key: string, params?: TranslationArgs, defaultValue?: string) => string;

// Type for the value returned by useI18n
export type I18nInterface = [
    TranslatorFn,
    {
        locale: Accessor<string>;
        setLocale: Setter<string>;
    }
];

// LocalStorage key for language
const LANG_STORAGE_KEY = 'lang';

// Define a type for the keys of the dictionaries object
type LangKey = keyof typeof dictionaries;

// Function to get initial locale
const getInitialLocale = (): LangKey => {
    const storedLang = localStorage.getItem(LANG_STORAGE_KEY);
    if (storedLang && storedLang in dictionaries) {
        return storedLang as LangKey;
    }
    // You might want to add browser language detection here as a fallback
    return defaultLang as LangKey;
};

// Create a signal for the current locale
const [locale, _setLocaleSignal] = createSignal<LangKey>(getInitialLocale());

// Wrapper for setLocale to also save to localStorage
const setLocaleSignal: Setter<string> = (langOrFn: string | ((prev: string) => string)) => {
    const newLang = typeof langOrFn === 'function' ? langOrFn(locale()) : langOrFn;
    if (newLang in dictionaries) {
        _setLocaleSignal(newLang as LangKey);
        localStorage.setItem(LANG_STORAGE_KEY, newLang);
    } else {
        console.warn(`Language "${newLang}" not supported. Falling back to default or current.`);
        // Optionally, fall back to default or do nothing
        // localStorage.setItem(LANG_STORAGE_KEY, defaultLang);
        // _setLocaleSignal(defaultLang as LangKey);
    }
};

const dict = createMemo(() => flatten(dictionaries[locale() as LangKey]));

const tFunction = translator(dict, resolveTemplate) as TranslatorFn; // Cast to the simplified TranslatorFn

// The value that useI18n will provide
const i18nInstanceValue: I18nInterface = [
    tFunction, // Now tFunction's asserted type matches TranslatorFn in I18nInterface
    {
        locale: locale, // Accessor for the current locale
        setLocale: setLocaleSignal // Setter to change the locale
    }
];

// Create the useI18n hook
export const useI18n = (): I18nInterface => {
  return i18nInstanceValue;
};

// Optionally, you can export the t function and locale actions directly from the instance
export const t = tFunction;
export const actions = {
    locale: locale,
    setLocale: setLocaleSignal,
};
export const setLocale = setLocaleSignal;
export const currentLocale = locale;
